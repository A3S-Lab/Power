name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to (re)build release assets for"
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: a3s-power
  BUILD_FEATURES: "--features hf,hw-verify"

jobs:
  # ───────────────────────────────────────────────
  # Gate: CI checks must pass before any publishing
  # ───────────────────────────────────────────────
  ci:
    name: CI Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup workspace
        run: bash .github/setup-workspace.sh

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Install OpenSSL dev
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --lib --all-features -- -D warnings

      - name: Tests
        run: cargo test --lib

  # ───────────────────────────────────────────────
  # Build release binaries for all platforms
  # ───────────────────────────────────────────────
  build:
    needs: ci
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: x86_64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: false

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup workspace
        run: bash .github/setup-workspace.sh

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install OpenSSL dev (Linux native)
        if: runner.os == 'Linux' && !matrix.use_cross
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Build release binary
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} ${{ env.BUILD_FEATURES }}
          else
            cargo build --release --target ${{ matrix.target }} ${{ env.BUILD_FEATURES }}
          fi

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package binaries
        id: package
        run: |
          TAG="${{ steps.tag.outputs.version }}"
          ARCHIVE="${BINARY_NAME}-${TAG}-${{ matrix.target }}.tar.gz"
          RELEASE_DIR="target/${{ matrix.target }}/release"

          cp "${RELEASE_DIR}/${BINARY_NAME}" "${BINARY_NAME}"
          cp "${RELEASE_DIR}/${BINARY_NAME}-verify" "${BINARY_NAME}-verify"

          tar czf "${ARCHIVE}" "${BINARY_NAME}" "${BINARY_NAME}-verify"
          shasum -a 256 "${ARCHIVE}" > "${ARCHIVE}.sha256"
          echo "archive=${ARCHIVE}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            ${{ steps.package.outputs.archive }}
            ${{ steps.package.outputs.archive }}.sha256

  # ───────────────────────────────────────────────
  # Create GitHub Release
  # ───────────────────────────────────────────────
  github-release:
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name '*.tar.gz' -o -name '*.sha256' \) -exec cp {} release/ \;
          ls -lh release/

      - name: Generate release notes
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            NOTES="Initial release"
          else
            NOTES=$(git log "${PREV_TAG}..HEAD" --oneline --no-merges --pretty=format:"- %s" | head -50)
          fi
          echo "$NOTES" > /tmp/release-notes.md

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.version }}"
          if gh release view "${TAG}" > /dev/null 2>&1; then
            echo "Release ${TAG} exists — uploading assets (overwriting duplicates)..."
            gh release upload "${TAG}" release/* --clobber
          else
            echo "Creating release ${TAG}..."
            gh release create "${TAG}" release/* \
              --title "${TAG}" \
              --notes-file /tmp/release-notes.md
          fi

  # ───────────────────────────────────────────────
  # Publish to crates.io
  # ───────────────────────────────────────────────
  publish-crate:
    name: Publish to crates.io
    needs: github-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenSSL dev
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --no-verify

  # ───────────────────────────────────────────────
  # Update Homebrew formula
  # ───────────────────────────────────────────────
  homebrew:
    name: Homebrew
    needs: github-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine tag
        id: tag
        run: echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Compute SHA256 values
        id: sha
        run: |
          TAG="${{ steps.tag.outputs.version }}"
          VERSION="${TAG#v}"
          for target in aarch64-apple-darwin x86_64-apple-darwin aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            ARCHIVE="a3s-power-${TAG}-${target}.tar.gz"
            SHA=$(sha256sum "artifacts/${target}/${ARCHIVE}" | awk '{print $1}')
            KEY=$(echo "${target}" | tr '-' '_')
            echo "${KEY}=${SHA}" >> "$GITHUB_OUTPUT"
          done
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          FORMULA_TAG: ${{ steps.tag.outputs.version }}
          FORMULA_VERSION: ${{ steps.sha.outputs.version }}
          SHA_AARCH64_DARWIN: ${{ steps.sha.outputs.aarch64_apple_darwin }}
          SHA_X86_64_DARWIN: ${{ steps.sha.outputs.x86_64_apple_darwin }}
          SHA_AARCH64_LINUX: ${{ steps.sha.outputs.aarch64_unknown_linux_gnu }}
          SHA_X86_64_LINUX: ${{ steps.sha.outputs.x86_64_unknown_linux_gnu }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/A3S-Lab/homebrew-tap.git tap
          cd tap

          python3 -c "
          import os
          tag = os.environ['FORMULA_TAG']
          ver = os.environ['FORMULA_VERSION']
          shas = {
              'aarch64_darwin': os.environ['SHA_AARCH64_DARWIN'],
              'x86_64_darwin': os.environ['SHA_X86_64_DARWIN'],
              'aarch64_linux': os.environ['SHA_AARCH64_LINUX'],
              'x86_64_linux': os.environ['SHA_X86_64_LINUX'],
          }
          base = f'https://github.com/A3S-Lab/Power/releases/download/{tag}/a3s-power-{tag}'
          formula = f'''class A3sPower < Formula
            desc \"Privacy-preserving LLM inference for TEE environments\"
            homepage \"https://github.com/A3S-Lab/Power\"
            version \"{ver}\"
            license \"MIT\"

            on_macos do
              on_arm do
                url \"{base}-aarch64-apple-darwin.tar.gz\"
                sha256 \"{shas['aarch64_darwin']}\"
              end
              on_intel do
                url \"{base}-x86_64-apple-darwin.tar.gz\"
                sha256 \"{shas['x86_64_darwin']}\"
              end
            end

            on_linux do
              on_arm do
                url \"{base}-aarch64-unknown-linux-gnu.tar.gz\"
                sha256 \"{shas['aarch64_linux']}\"
              end
              on_intel do
                url \"{base}-x86_64-unknown-linux-gnu.tar.gz\"
                sha256 \"{shas['x86_64_linux']}\"
              end
            end

            def install
              bin.install \"a3s-power\"
              bin.install \"a3s-power-verify\"
            end

            test do
              assert_match \"a3s-power\", shell_output(\"#{{bin}}/a3s-power --version\")
            end
          end
          '''
          import textwrap
          with open('Formula/a3s-power.rb', 'w') as f:
              f.write(textwrap.dedent(formula))
          "

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/a3s-power.rb
          git commit -m "chore: update a3s-power to ${FORMULA_TAG}"
          git push
